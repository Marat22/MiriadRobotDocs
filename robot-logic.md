# Логический уровень робота
В данном файле описано устройство робота на логическом уровне.

Содержание:
- [Логический уровень робота](#логический-уровень-робота)
  - [Выбор подхода к реализации](#выбор-подхода-к-реализации)
  - [Термины](#термины)
  - [Общий обзор](#общий-обзор)
  - [Модули робота](#модули-робота)
    - [Планировщик](#планировщик)
    - [ИнтерфейсАналитики](#интерфейсаналитики)
    - [ИнтерфейсФреймворка](#интерфейсфреймворка)
    - [Заявки](#заявки)
    - [Фьючерсы](#фьючерсы)
    - [Свечи](#свечи)
    - [Индексы](#индексы)
    - [Сценарии](#сценарии)
    - [ХранилищеБиржевыхДанных](#хранилищебиржевыхданных)
    - [РегуляторПодписок](#регуляторподписок)
- [РегуляторКоллбеков](#регуляторколлбеков)
    - [Адаптер](#адаптер)
  - [Общий процесс](#общий-процесс)
    - [1 Обновление фьючерсов](#1-обновление-фьючерсов)
    - [2 Передача свечей аналитике](#2-передача-свечей-аналитике)
      - [2.2 Очистка очереди заявок и снятие заявок с биржи](#22-очистка-очереди-заявок-и-снятие-заявок-с-биржи)
      - [2.6 Обработка свечей аналитикой](#26-обработка-свечей-аналитикой)
    - [3 Отправка заявок из очереди](#3-отправка-заявок-из-очереди)
    - [4 Проверка отправленных заявок](#4-проверка-отправленных-заявок)
    - [5 Обновление биржевых данных](#5-обновление-биржевых-данных)
    - [6 Обработка коллбеков](#6-обработка-коллбеков)
      - [6.1 Обработка ответов на заявки](#61-обработка-ответов-на-заявки)
  - [Структуры данных](#структуры-данных)
    - [СыраяСвеча](#сыраясвеча)
    - [АналитическаяСвеча](#аналитическаясвеча)
    - [АналитическаяЗаявка](#аналитическаязаявка)
    - [АналитическийОтветНаЗаявку](#аналитическийответназаявку)
    - [Фьючерс](#фьючерс)
    - [БиржевыеДанные](#биржевыеданные)

## Выбор подхода к реализации
Фреймворк должен в себе сочетать **ООП** (объектно ориентированное программирование) и **ФП** (функциональное программирование).

ФП позволяет сделать код более читабельным и простым, однако ФП в чистом виде не подходит, т.к. есть необходимость хранить и изменять объекты. Поэтому во фреймворке также должны быть использованы принципы ООП. Однако использовать только ООП тоже неправильно, потому что во многих частях программы ООП будет излишнем и создаст дополнительные сложности.

От ООП берём:
- возможность хранить и изменять объекты

От ФП берём:
- простота
- чистые функции

## Термины
- Позиции — открытые сделки по инструментам
- Аналитические свечи — свечи в [формате аналитики](#аналитическаясвеча).

## Общий обзор
- Робот делится на две составляющие: Аналитика и Фреймворк.
- Аналитика — встраиваемая часть робота, отвечающая за принятие решений об отправке заявок.
  - В данном документе не рассматриваются детали устройства Аналитики, только её вход и выход, т.к. Аналитика лишь встраивается в робота, к тому же она пишется другим разработчиком. 
- Фреймворк — часть робота, позволяющая Аналитике торговать на бирже.

Общий процесс можно представить так:
```mermaid
sequenceDiagram
    Брокер->>Фреймворк: Присылает биржевые данные
    Фреймворк->>Аналитика: Преобразует данные и передаёт их для анализа
    Аналитика->>Аналитика: Принимает решение о покупке
    Аналитика->>Фреймворк: Передаёт команду купить
    Фреймворк->>Брокер: Отправляет заявку на покупку
```

## Модули робота
В данной секции будут описаны модули Робота. 

<!-- В каждом описании можно найти:
- описания функций модуля для внешнего использования.
- описание того, как модуль взаимодействует с другими модулями, через процессы. В этих описаниях опущены детали работы других модулей и основная концентрация идёт на описываемый модуль. -->

### Планировщик
— центральный модуль программы, который вызывает функции, которые требуется вызывать регулярно (функции можно увидеть далее).

Для нормальной работы программы, нужно регулярно запускать определённые функции:
- [Фьючерсы](#фьючерсы).обновить_фьючерсы()
- [Свечи](#свечи).передать_свечи_аналитике()
- [Заявки](#заявки).отправить_заявки_из_очереди()
- [Заявки](#заявки).проверить_отправленные_заявки()
- [ХранилищеБиржевыхДанных](#хранилищебиржевыхданных).обновить_биржевые_данные()
- [РегуляторКоллбеков](#регуляторколлбеков).передать_коллбеки()

```mermaid
classDiagram
  class  Планировщик{
    +запустить_планировщик()
  }
```

Публичные функции:
- запустить_планировщик() — функция, которая с определённой периодичностью бесконечно вызывает  функции, перечисленные выше.

### ИнтерфейсАналитики
— модуль, через который фреймворк взаимодействует с аналитикой. 

`ИнтерфейсАналитики` нужен для того, чтобы фреймворк мог обращаться к функциям аналитики. Например, для того, чтобы передать свечи для обработки или передать ответы на заявки. 
<!-- Если модули фреймворка будут напрямую вызывать функции аналитики, то в программе связи внутри между аналитикой и фреймворком будут запутаны, поэтому были введены специальные интерфейсы: Аналитика может взаимодействовать с фреймворком —  -->

```mermaid
classDiagram
  class ИнтерфейсАналитики{
    +обработать_свечи(аналитические свечи) Заявки
    +обработать_ответы_на_заявки(ответы на заявки) None
  }

```

Описание функций для внешнего использования:
- +обработать_свечи() — передаёт [аналитические свечи](#термины) от фреймворка к аналитике.
- +обработать_ответы_на_заявки() — передаёт [ответы](#аналитическийответназаявку) на отправленные заявки от фреймворка к аналитике.

### ИнтерфейсФреймворка
— модуль, через который аналитика взаимодействует с фреймворком.

`ИнтерфейсАналитики` нужен для того, чтобы Аналитика могла обращаться к функциям Фреймворка. Например, для того, чтобы запросить свечи текущую стоимость портфеля.

```mermaid
classDiagram
  class ИнтерфейсФреймворка{
    +получить_исторические_свечи(тикер, период) исторические свечи
    +получить_стоимость_портфеля() стоимость портфеля
    +положить_заявку_в_очередь(аналитическая заявка) 
  }

```

Описание функций для внешнего использования:
- получить_исторические_свечи() — возвращает массив с ценами закрытий за указанное количество дней.
- получить_стоимость_портфеля() — возвращает текущую стоимость портфеля
- положить_заявку_в_очередь() — кладёт [аналитическую заявку](#аналитическаязаявка) в очередь заявок на отправку на биржу.

### Заявки
— модуль, отвечающий за отправку заявок из аналитики на биржу и передачу ответов на заявки из биржи в аналитику.

Для того, чтобы открывать позиции на бирже, нужно отправлять **заявки**. Заявки можно отправлять только в **торговое время**, в **неторговое время** заявки не принимаются. Неторговым временем считается ночь (с 23:45 до 11:00) и клиринг (с 18:45 до 19:05), также неторговое время может наступить и в другие моменты, когда, например, потеряно соединение с биржей или возникли какие-то проблемы на стороне брокера, не позволяющие отправить заявку.

В связи с тем, что существует **неторговое время**, заявки отправляются не сразу, а сначала кладутся в **очередь заявок** с помощью функции `положить_заявку_в_очередь()`. Затем, когда наступает **торговое время**, заявки из очереди отправляются на биржу (с помощью функции `отправить_заявки_из_очереди()`). 

Также, когда заявка исполнилась или отклонилась, биржа в течение 5 секунд присылает **ответ на заявки**. Ответы на заявки должны быть переданы `Аналитике` в [соответствующем формате](#аналитическийответназаявку). Обработка этих ответов и передача их в `Аналитику` происходит в `обработать_ответ_на_заявку()`. 

Однако также существуют случаи, когда в `Аналитику` требуется отправить **симулированные ответы на заявки**. Это значит, что реального ответа на заявку от биржи не приходило, но для `Аналитики` мы симулируем этот ответ. Симулированный ответ не отличается по структуре от обычного [аналитического ответа на заявку](#аналитическийответназаявку), просто количество исполненных лотов будет равно 0. Симулировать ответы нужно потому, что есть требование, что на каждую отправленную `Аналитикой` заявку ей должен возвращаться ответ. Необходимость симулировать ответы на заявки есть в следующих функциях:
- `проверить_отправленные_заявки()` — нужно симулировать ответ, если заявка слишком долго ждёт ответа.
- `очистить_очередь_заявок()` и `снять_все_заявки_на_бирже()` — нужно симулировать ответ, если нужно отправить следующую свечу в Аналитику.

Обычно после отправки заявки ответ на неё сразу же приходит, однако есть очень маленькая вероятность того, что ответ на заявку от брокера не придёт вообще. Такая ситуация может возникнуть в том случае, если, например, после отправки заявки Робот сразу же потерял соединение с брокером, так что ответ на заявку попросту не был принят. Чтобы понять, что заявка не была исполнена, нужно хранить все отправленные заявки, пока на них не пришёл ответ. Такие заявки хранятся в **списке отправленных заявок**. Функция `проверить_отправленные_заявки()` проверяет, что заявки в **списке отправленных заявках** лежат там не дольше минуты. Если дольше, то они удаляются из **списка отправленных заявок**, в `Аналитику` отправляются **симулированные ответы на заявки** и затем выводится предупреждение, что ответ на заявку не был получен. В нормальном случае заявки из **списка отправленных заявок** удаляются при обработке ответов на заявки в функции `обработать_ответ_на_заявку()`.

Есть вероятность того, что нужно удалить все заявки из очереди (`очистить_очередь_заявок()`) и снять\* все заявки на бирже (`снять_все_заявки_на_бирже()`). Данные функции необходимы по причине того, что есть требование, что перед отправкой свечей в Аналитику нужно удалить все заявки из очереди и снять все заявки на бирже. Обратите внимание, в этих функциях также происходит отправка **симулированных ответов на заявки**.

\*Снять заявку — это значит отменить отправленную заявку. Если заявка отменена, то значит она уже никогда не будет исполнена. Снять заявку можно только если она ещё не исполнилась или не отклонилась биржей.

<!-- Также есть вероятность того, что нужно отозвать все отправленные заявки с биржи, в этом случае вызывается `снять_все_заявки_на_бирже`, причины данного события описаны в модуле [Свечи](#свечи). -->
<!-- 
Важный нюанс: т.к. `Аналитика` должна получить ответы на все, отправленные ею заявку снять_все_заявки_на_бирже()` и `очистить_очередь_заявок` передача ответов -->

Внешний интерфейс
```mermaid
classDiagram
  class Заявки{
    +положить_заявку_в_очередь(аналитическая заявка)
    +отправить_заявки_из_очереди()
    +обработать_ответ_на_заявку(ответ биржи на заявку)
    +очистить_очередь_заявок()
    +снять_все_заявки_на_бирже()
  }
```

Описание функций для внешнего использования:
- положить_заявку_в_очередь() — кладёт [аналитическую заявку](#аналитическаязаявка) в очередь заявок
- отправить_заявки_из_очереди() — отправляет заявки из очереди заявок на биржу
- обработать_ответ_на_заявку() — преобразует ответ биржи на заявку в формат [аналитического ответа на заявку](#аналитическийответназаявку) и передаёт ответ в аналитику.
- очистить_очередь_заявок() — удаляет все заявки из очереди заявок. 
- снять_все_заявки_на_бирже() — снимает все заявки на бирже.
- проверить_отправленные_заявки() — проверяет, есть ли заявки, которые ждут ответа больше минуты (ответ на заявку обычно должен приходить в пределах 5 секунд). Если такие есть, то они удаляются, а затем выводится предупреждение, что на заявку не пришёл ответ.

### Фьючерсы
— модуль, отвечающий за хранение и обновление информации о фьючерсах по тикерам.

На запуске программы робот загружает конфиг. В конфиге есть тикеры. Тикер — название базового актива фьючерса. Фьючерс — производная базового актива. По одному Тикеру существует множество Фьючерсов. Фьючерсы, в отличие от тикеров, имеют **дату экспирации**. После **даты экспирации** фьючерс больше не торгуется. Если Фьючерс ещё не закончился, то мы его называем **живым**. Одновременно по одному тикеру может быть несколько **живых** Фьючерсов, однако ликвиден всегда только один — фьючерс с ближайшей датой экспирации, мы его называем **активным**. **Однако** в день экспирации фьючерса он перестаёт быть активным, и активным становится следующий фьючерс с ближайшей датой экспирации. 

Отслеживаемые тикеры — тикеры, с которыми сейчас работает робот.
Отслеживаемые фьючерсы — фьючерсы по отслеживаемым тикерам, с которыми сейчас работает робот. По каждому тикеру может быть только один отслеживаемый фьючерс.
Текущий фьючерс — то же самое, что отслеживаемый фьючерс.

Модуль хранит у себя **отслеживаемые** (текущие) фьючерсы. Это фьючерсы, с которыми работает робот, т.е. те фьючерсы, по которым он получает свечи, запрашивает биржевые данные, отправляет заявки.

Задача модуля заключается в том, чтобы определять, какие фьючерсы сейчас активны, а также предоставлять данные об активных фьючерсах другим модулям.

```mermaid
classDiagram
  class Фьючерсы{
    +обновить_фьючерсы()
    +получить_информацию_по_фьючерсу()
  }
```

Описание функций для внешнего использования:
- обновить_фьючерсы() — определяет и сохраняет текущие фьючерсы по отслеживаемым тикерам.
- получить_информацию_по_фьючерсу(тикер) — возвращает информацию об **текущем** фьючерсе тикера.

### Свечи
— модуль, отвечающий за формирование [аналитических свечей](#аналитическаясвеча) и поставку их в аналитику.

В аналитику нужно регулярно передавать свечи для обработки.

Свечи, которые робот получает от биржи, являются [сырыми](#сыраясвеча) и они не подходят для использования аналитикой. Перед тем, как передать свечи аналитике, нужно сделать определённые преобразования. После выполнения всех преобразований должна получиться [аналитическая свеча](#аналитическаясвеча).


Преобразовывать свечу из сырой в аналитическую надо в определённом порядке:
1. Определить сценарии, которые нужно выполнить. Если никаких сценариев не нужно выполнять, то свечи и не отправляются.
2. Если нужно выполнить сценарий, то в соответствие с требованием\* производится очистка очереди заявок и снятие заявок на бирже.
3. В зависимости от выбранного сценария запрашиваются свечи.  
   1. Если сценарий свечи — последняя свеча фьючерса, то запрашивается свеча фьючерса.
   2. В остальных случай запрашивается свеча текущего фьючерса.
4. В зависимости от фьючерса свечи, полученной в прошлом пункте, запрашиваем биржевые данные по нужному фьючерсу.
5. Запрашиваем индексы свечей

\*Есть требование, что перед отправкой свечей в `Аналитику` нужно удалить все заявки из очереди заявок и снять все заявки на бирже. Поэтому сразу после того, как определили сценарий, заявки из очереди заявок удаляются и все заявки на бирже снимаются.

```mermaid
classDiagram

  class Свечи{
    +передать_свечи_аналитике()
    +получить_исторические_свечи()
  }

```

Описание функций для внешнего использования:
- передать_свечи_аналитике() — формирует и отправляет [аналитические свечи](#аналитическаясвеча) в аналитику. Здесь задаются значения всех атрибутов [аналитических свечей](#аналитическаясвеча).
- получить_исторические_свечи() — возвращает исторические свечи для аналитики.

### Индексы
— модуль, отвечающий за индексы свечей, передаваемых в аналитику.

Индекс — атрибут [аналитической свечи](#аналитическаясвеча), идентифицирующий её среди других свечей по тикеру. 

В `Аналитику` свечи отправляются наборами. В каждом наборе находятся свечи по всем отслеживаемым инструментам. **У всех свечей в** таком **наборе** должен быть **одинаковый индекс**.

В основном `Аналитика` использует индексы в логировании. Например, чтобы указать, что такое-то событие произошло в такое-то время, используются индекс свечи, на которой произошло событие. Это не единственное использование индексов, однако самое основное.

Индексы свечей определяются по принципу... (пока неизвестно)

Модуль `Индексы` занимается тем, чтобы определять индексы свечей.
<!-- 
```mermaid
classDiagram
  class Индексы{
    +получить_индекс_следующих_свечей() 
  }
``` 
-->
Описание функций для внешнего использования:
- получить_индекс_следующих_свечей() — возвращает индекс свечей.

<!-- Требования:
- В `Аналитику` свечи отправляются наборами. В каждом наборе находятся свечи по всем отслеживаемым инструментам. **У всех свечей в** таком **наборе** должен быть **одинаковый индекс**.
- **Индекс может только увеличиваться**. Т.е. если в аналитику передана свеча с индексом 100, то в следующий индекс должен быть больше 100. -->

### Сценарии
— модуль, отвечающий за определение сценариев свечей. 

Сценарий — атрибут [аналитической свечи](#аналитическаясвеча), который определяет какие действия нужно выполнить со свечой.

Сценарии бывают следующие:
- NRL — нормальная свеча
- FF — первая свеча фьючерса
- LF — последняя свеча фьючерса

```mermaid
classDiagram
  class Сценарии{
    +получить_сценарии()
  }
```

Описание функций для внешнего использования:
- получить_сценарии() — возвращает сценарии свечей.

### ХранилищеБиржевыхДанных
— модуль, отвечающий за хранение и обновление биржевых данных. Формат биржевых данных описан [здесь](#биржевыеданные).

Биржевые данные — данные о фьючерсах, являющиеся атрибутами [аналитической свечи](#аналитическаясвеча).

Биржевые данные нужно обновлять после каждого клиринга (после 19:05).

```mermaid
classDiagram
  class ХранилищеБиржевыхДанных{
    +обновить_биржевые_данные()
    +получить_биржевые_данные()
  }
```
Описание функций для внешнего использования:
- обновить_биржевые_данные() — обновляет биржевые данные.
- получить_биржевые_данные() — возвращает биржевые данные.

Процесс работы:
```mermaid
sequenceDiagram
  participant Планировщик
  participant Свечи
  participant ХранилищеБиржевыхДанных
  participant Адаптер
  participant ИнтерфейсАналитики

  Планировщик->>ХранилищеБиржевыхДанных: Вызывает `обновить_биржевые_данные()`
  ХранилищеБиржевыхДанных->>Адаптер: запрашивает биржевые данные
  Адаптер-->>ХранилищеБиржевыхДанных: возвращает биржевые данные
  ХранилищеБиржевыхДанных->>ХранилищеБиржевыхДанных: сохраняет биржевые данные
  Планировщик->>Свечи: Вызывает `передать_свечи_аналитике()`
  Свечи->>Свечи: Собирает данные для аналитических свечей ...
  Свечи->>ХранилищеБиржевыхДанных: Вызывает `получить_биржевые_данные()`
  ХранилищеБиржевыхДанных-->>Свечи: Возвращает биржевые данные по инструментам свечей
  Свечи->>Свечи: ... собирает данные для аналитических свечей
  Свечи->>ИнтерфейсАналитики: Передаёт аналитические свечи  
```
### РегуляторПодписок
— модуль, отвечающий за подписки на данные.

Чтобы брокер присылал роботу новые цены фьючерсов и ответы на заявки, нужно подписаться на получение этих данных. Данный модуль отвечает за все подписки.

Если соединения с брокером было потеряно, то при восстановлении соединения все подписки нужно возобновить.

```mermaid
classDiagram
  class РегуляторПодписок{
    +подписаться_на_фьючерс(тикер, сек код)
    +отписаться_от_фьючерса(тикер, сек код)
    +подписаться_на_ответы_на_заявки()
    +отписаться_от_ответов_на_заявки()
  }
```

Описание функций для внешнего использования:
- подписаться_на_фьючерс() — подписывается на получение цен по фьючерсу
- отписаться_от_фьючерса() — отписывается от получения цен по фьючерсу
- подписаться_на_ответы_на_заявки() — подписывается на получение ответов на заявки
- отписаться_от_ответов_на_заявки() — отписывается от получения ответов на заявки

# РегуляторКоллбеков
— модуль, отвечающий за передачу коллбеков модулям, ожидающим этих коллбеков.

В робота регулярно приходят коллбеки от биржи. Чтобы обрабатывать их централизованно, бы введён данный модуль. Он отвечает за то, чтобы забрать пришедшие коллбеки из `Адаптера` и передать их нужным модулям. 

Коллбеки и модули, ожидающие их получения:
- Ответы на заявки передаются модулю `Заявки` через функцию `обработать_ответы_на_заявки()`.
<!-- - Свечи должны передаваться модулю `Свечи` через функцию `обработать_ответы_на_заявки()`. -->

```mermaid
classDiagram
  class РегуляторКоллбеков{
    +передать_коллбеки()
  }
```

Описание функций для внешнего использования:
- передать_коллбеки() — передаёт коллбеки в соответствующие функции модулей (коллбеки и модули смотрите чуть выше).

### Адаптер
— модуль отвечающий за коммуникацию с биржей. Он преобразует данные из биржи в формат, нужный аналитике, а данные от аналитики в формат биржи.

```mermaid
classDiagram
  class Адаптер{
    +подписаться_на_фьючерс(тикер, сек код)
    +отписаться_от_фьючерса(тикер, сек код)
    +подписаться_на_ответы_на_заявки()
    +отписаться_от_ответов_на_заявки()
    +получить_все_коллбеки()
    +получить_текущие_позиции() dict[код_фьючерса: количество_позиций]
    +отправить_заявку(аналитическая_заявка) 
    +получить_го(код_фьючерса) го
    +получить_стоимость_шага(код_фьючерса) стоимость_шага
    +можно_ли_сейчас_торговать(код_фьючерса) True/False
    +получить_стоимость_портфеля() стоимость_портфеля
    +получить_информацию_о_фьючерсах(тикер) информация_о_фьючерсах
  }
```

## Общий процесс
В данной секции описаны все основные процессы, происходящие в роботе. Процессы, которые включают в себя несколько других процессов, описаны подробно, другие процессы описаны не так подробно. Например, процесс "[передача свечей аналитике](#2-передача-свечей-аналитике)" включает в себя множество других процессов и под него есть [отдельная секция](#2-передача-свечей-аналитике), а вот "получение свечей с биржи" не включает других процессов и поэтому отдельный секции под него нету.

Основной процесс робота, который происходит постоянно:
```mermaid
sequenceDiagram
  loop Каждую минуту
  Планировщик->>Фьючерсы: вызывает `обновить_фьючерсы()` (процесс 1)
  Планировщик->>Свечи: вызывает `передать_свечи_аналитике()` (процесс 2)
  Планировщик->>Заявки: вызывает `отправить_заявки_из_очереди()` (процесс 3)
  Планировщик->>Заявки: вызывает `проверить_отправленные_заявки()` (процесс 4)
  Планировщик->>ХранилищеБиржевыхДанных: вызывает `обновить_биржевые_данные()` (процесс 5)
  Планировщик->>РегуляторКоллбеков: вызывает `передать_коллбеки()` (процесс 6)
  end
```

Данный процесс включает в себя следующие процессы:
- процесс 1 [обновление фьючерсов](#1-обновление-фьючерсов)
- процесс 2 [передача свечей аналитике](#2-передача-свечей-аналитике)
- процесс 3 [отправка заявок из очереди](#3-отправка-заявок-из-очереди)
- процесс 4 [проверка отправленных заявок](#4-проверка-отправленных-заявок)
- процесс 5 [обновление биржевых данных](#5-обновление-биржевых-данных)
- процесс 6 [обработка коллбеков](#6-обработка-коллбеков)

### 1 Обновление фьючерсов
Процесс обновления фьючерсов нужен для того, чтобы в день экспирации фьючерса заменить его на следующий. Подробнее про фьючерсы можно почитать [здесь](#фьючерсы).

```mermaid
sequenceDiagram
  participant Планировщик
  participant Фьючерсы
  participant РегуляторПодписок
  participant Планировщик

  Планировщик->>Фьючерсы: Вызывает `обновить_фьючерсы()`
  activate Фьючерсы
  loop Каждый тикер
  opt Если сегодня дата экспирации фьючерса
  Фьючерсы->>Адаптер: Запрашивает информацию о фьючерсах по тикеру
  Адаптер-->>Фьючерсы: Возвращает информацию о фьючерсах по тикеру
  Фьючерсы->>Фьючерсы: Определяет какой фьючерс сейчас активен
  Фьючерсы->>РегуляторПодписок: Подписывается на получение цен по активному фьючерсу
  РегуляторПодписок->>Адаптер: Отправляет запрос на подписку на цены фьючерса
  alt если подписка прошла успешно
  Адаптер-->>РегуляторПодписок: Присылает подтверждение подписки
  Фьючерсы->>Фьючерсы: Сохраняет данные о текущем фьючерсе
  else если подписаться не получилось
  Адаптер-->>РегуляторПодписок: Присылает ошибку, возникшую при подписке
  end
  end
  end
  deactivate Фьючерсы
```

### 2 Передача свечей аналитике
Данный процесс нужен для того, чтобы аналитика регулярно получала свечи в [нужном формате](#аналитическаясвеча).

```mermaid
sequenceDiagram
    Планировщик->>Свечи: Вызывает `передать_свечи_аналитике()`
    Свечи->>Сценарии: Запрашивает сценарии свечей (процесс 2.1)
    Сценарии-->>Свечи: Возвращает сценарии свечей (процесс 2.1)

    Свечи->>Заявки: Вызывает `очистить_очередь_заявок()` (процесс 2.2)
    Свечи->>Заявки: Вызывает `снять_все_заявки_на_бирже()` (процесс 2.2)
    Свечи->>Адаптер: Запрашивает свечи (процесс 2.3)
    Адаптер-->>Свечи: Возвращает сырые свечи (процесс 2.3)
    Свечи->>ХранилищеБиржевыхДанных: Запрашивает биржевые данные по инструментам свечей (процесс 2.4)
    ХранилищеБиржевыхДанных-->>Свечи: Возвращает биржевые данные по инструментам свечей (процесс 2.4)
    Свечи->>Индексы: Запрашивает индекс свечей (процесс 2.5)
    Индексы-->>Свечи: Возвращает индекс свечей (процесс 2.5)
    Свечи->>ИнтерфейсАналитики: Передаёт аналитические свечи (процесс 2.6)
    ИнтерфейсАналитики->>Аналитика: Передаёт аналитические свечи (процесс 2.6)
```

Данный процесс включает в себя следующие процессы:
- процесс 2.1 определение сценариев свечей
- процесс 2.2 [очистка очереди заявок и снятие заявок с биржи](#22-очистка-очереди-заявок-и-снятие-заявок-с-биржи)
- процесс 2.3 получение свечей с биржи
- процесс 2.4 получение биржевых данных по фьючерсам свечей
- процесс 2.5 получение индексов свечей
- процесс 2.6 [обработка свечей аналитикой](#26-обработка-свечей-аналитикой)

<!--
Данные процессы нужно выполнять именно в этом порядке
1. Определить сценарии, которые нужно выполнить. Если никаких сценариев не нужно выполнять, то свечи и не отправляются.
2. Если нужно выполнить сценарий, то в соответствие с требованием\* производится очистка очереди заявок и снятие заявок на бирже.
3. В зависимости от выбранного сценария запрашиваются свечи.
   1. Если сценарий свечи — последняя свеча фьючерса, то запрашивается свеча фьючерса.
   2. В остальных случай запрашивается свеча текущего фьючерса.
4. В зависимости от фьючерса свечи, полученной в прошлом пункте, запрашиваем биржевые данные по нужному фьючерсу.
5. Запрашиваем индексы свечей

\*Есть требование, что перед отправкой свечей в `Аналитику` нужно удалить все заявки из очереди заявок и снять все заявки на бирже. Поэтому сразу после того, как определили сценарий, заявки из очереди заявок удаляются и все заявки на бирже снимаются.
 -->

#### 2.2 Очистка очереди заявок и снятие заявок с биржи
```mermaid
sequenceDiagram
  participant Свечи
  participant Заявки
  participant Адаптер
  participant ИнтерфейсАналитики

  Свечи->>Заявки: Вызывает `очистить_очередь_заявок()` (процесс 2.2.1)
  Заявки->>Заявки: Очищает очередь заявок (процесс 2.2.1)
  Заявки->>ИнтерфейсАналитики: Вызывает `обработать_ответы_на_заявки()` (процесс 2.2.1)

  Свечи->>Заявки: Вызывает `снять_все_заявки_на_бирже()` (процесс 2.2.2)
  Заявки->>Адаптер: Снимает все заявки (процесс 2.2.1)
  Заявки->>ИнтерфейсАналитики: Вызывает `обработать_ответы_на_заявки()` (процесс 2.2.3)
```

Данный процесс включает в себя следующие процессы:
- процесс 2.2.1 Очистка очереди заявок
- процесс 2.2.2 Снятие заявок с биржи

**Обратите внимание**, несмотря на то, что на заявки не приходили ответы, в `ИнтерфейсАналитики` всё равно отправляем имитированные ответы на заявки, в которых количество исполненных лотов равно 0. Это необходимо сделать в связи с устройством`Аналитики`.

#### 2.6 Обработка свечей аналитикой
Данная диаграмма показывает обработку свечей с точки зрения фреймворка, детали аналитике не описаны.

```mermaid
sequenceDiagram
    participant ИнтерфейсАналитики
    participant Аналитика
    participant ИнтерфейсФреймворка
    participant Свечи
    participant Адаптер
    participant Заявки

    Свечи->>ИнтерфейсАналитики: передаёт свечи для обработки
    activate Свечи
    ИнтерфейсАналитики->>Аналитика: передаёт свечи для обработки
    activate Аналитика

    opt
    Аналитика->>ИнтерфейсФреймворка: вызывает `получить_исторические_свечи()` (процесс 2.6.1)
    activate ИнтерфейсФреймворка
    ИнтерфейсФреймворка->>Свечи: запрашивает исторические свечи (процесс 2.6.1)
    Свечи-->>ИнтерфейсФреймворка: возвращает исторические свечи (процесс 2.6.1)
    ИнтерфейсФреймворка-->>Аналитика: возвращает исторические свечи (процесс 2.6.1)
    deactivate ИнтерфейсФреймворка
    end

    opt
    Аналитика->>ИнтерфейсФреймворка: вызывает `получить_стоимость_портфеля()` (процесс 2.6.2)
    activate ИнтерфейсФреймворка
    ИнтерфейсФреймворка->>Адаптер: запрашивает стоимость портфеля (процесс 2.6.2)
    Адаптер-->>ИнтерфейсФреймворка: возвращает стоимость портфеля (процесс 2.6.2)
    ИнтерфейсФреймворка-->>Аналитика: возвращает текущую стоимость портфеля (процесс 2.6.2)
    deactivate ИнтерфейсФреймворка
    end

    opt Аналитика решила отправить заявку
    Аналитика->>ИнтерфейсФреймворка: передаёт заявку в очередь заявок (процесс 2.6.3)
    activate ИнтерфейсФреймворка
    ИнтерфейсФреймворка->>Заявки: добавляет заявку в очередь заявок на отправку (процесс 2.6.3)
    end

    deactivate ИнтерфейсФреймворка
    deactivate Аналитика
    deactivate Свечи
```

Данный процесс включает в себя следующие процессы:
- процесс 2.6.1 получение исторических свечей
- процесс 2.6.2 получение стоимости портфеля
- процесс 2.6.3 добавление заявки в очередь заявок
  - **обратите внимание**, здесь заявки не отправляются, а именно добавляются в очередь на отправку. Сама отправка заявок происходит только в процессе [отправки заявок из очереди](#3-отправка-заявок-из-очереди), который запускается [планировщиком](#планировщик) в [общем процессе](#общий-процесс) робота.

### 3 Отправка заявок из очереди
Данный процесс нужен для того, чтобы отправить заявки из очереди, которые в неё были добавлены в процессе [обработки свечей аналитикой](#обработка-свечей-аналитикой)

```mermaid
sequenceDiagram
  Планировщик->>Заявки: вызывает `отправить_заявки_из_очереди()`
  Заявки->>Адаптер: отправляет заявки
```

### 4 Проверка отправленных заявок
Здесь происходит удаление заявок из списка отправленных заявок и эмуляция ответов на заявки для аналитики в случае, если ответы на заявки не были получены. Подробнее об этом можно почитать в секции [заявок](#заявки).

```mermaid
sequenceDiagram
  Планировщик->>Заявки: вызывает `проверить_отправленные_заявки()`
  opt Ответа на заявку нет больше минуты
  Заявки->>ИнтерфейсАналитики: вызывает `обработать_ответы_на_заявки()`
  ИнтерфейсАналитики->>Аналитика: передаёт ответы на заявки для обработки
  end
```

### 5 Обновление биржевых данных
Данный процесс нужен для того, чтобы поддерживать актуальность биржевых данных в [ХранилищеБиржевыхДанных](#хранилищебиржевыхданных).

```mermaid
sequenceDiagram
  participant Планировщик
  participant ХранилищеБиржевыхДанных
  participant Адаптер

  Планировщик->>ХранилищеБиржевыхДанных: Вызывает `обновить_биржевые_данные()`
  loop Каждый тикер
  ХранилищеБиржевыхДанных->>Адаптер: запрашивает биржевые данные
  Адаптер-->>ХранилищеБиржевыхДанных: возвращает биржевые данные
  ХранилищеБиржевыхДанных->>ХранилищеБиржевыхДанных: сохраняет биржевые данные
  end
```

### 6 Обработка коллбеков
В данном процессе описана обработка коллбеков, пришедшие от биржи.

```mermaid
sequenceDiagram
  Планировщик->>РегуляторКоллбеков : Вызывает `передать_коллбеки()`
  opt Пришёл ответ на заявку
  РегуляторКоллбеков->>Заявки : Вызывает `обработать_ответы_на_заявки()` (процесс 6.1)
  end
```

Данный процесс включает в себя следующие процессы:
- процесс 6.1 [обработка ответов на заявки](#61-обработка-ответов-на-заявки)

#### 6.1 Обработка ответов на заявки

```mermaid
sequenceDiagram
  РегуляторКоллбеков->>Заявки : Вызывает `обработать_ответы_на_заявки()`
  Заявки->>Заявки : Вызывает `обработать_ответы_на_заявки()`
  Заявки->>ИнтерфейсАналитики: передаёт ответы на заявки в формате аналитики
  ИнтерфейсАналитики->>Аналитика: передаёт ответы на заявки в формате аналитики
```

## Структуры данных
### СыраяСвеча
— формат свеч, получаемых от биржи.

| Тип атрибута | Название атрибута | Значение атрибута                                                |
|--------------|-------------------|------------------------------------------------------------------|
| date         | дата              | дата свечи                                                       |
| float        | цена              | цена закрытия свечи                                              |
| str          | код               | код фьючерса свечи                                               |
| str          | тикер             | тикер                                                            |

### АналитическаяСвеча
— формат свечи для отправки в `Аналитику`.

| Тип атрибута | Название атрибута | Значение атрибута                                                |
|--------------|-------------------|------------------------------------------------------------------|
| date         | дата              | дата свечи                                                       |
| int          | индекс            | число, идентифицирующее свечу среди других свечей по тикеру      |
| float        | цена              | цена закрытия свечи                                              |
| str          | код               | код фьючерса свечи                                               |
| str          | сценарий          | сценарий свечи, который нужно выполнить в аналитике              |
| str          | тикер             | тикер                                                            |
| float        | го                | текущее ГО                                                       |
| float        | расчётная_цена    | текущая расчётная цена                                           |
| float        | стоимость_шага    | текущая стоимость шага                                           |

Атрибут `сценарий` может быть равен:
- NRL — нормальная свеча
- FF — первая свеча фьючерса
- LF — последняя свеча фьючерса

`сценарий` определяет какие действия требуется выполнить со свечой в аналитике.
### АналитическаяЗаявка
| Тип атрибута | Название атрибута | Значение атрибута                                       |
|--------------|-------------------|---------------------------------------------------------|
| str          | тикер             | тикер                                                   |
| str          | направление       | направление заявки (либо "B" покупка, либо "S" продажа) |
| int          | количество        | количество лотов в заявке                               |
### АналитическийОтветНаЗаявку
| Тип атрибута | Название атрибута | Значение атрибута                                       |
|--------------|-------------------|---------------------------------------------------------|
| str          | тикер             | тикер                                                   |
| str          | направление       | направление заявки (либо "B" покупка, либо "S" продажа) |
| int          | количество        | количество исполненных лотов                            |
### Фьючерс
Формат, в котором хранится информация о фьючерсе:
| Тип атрибута | Название атрибута | Значение атрибута        |
|--------------|-------------------|--------------------------|
| str          | тикер             | тикер                    |
| str          | код               | код фьючерса             |
| date         | дата_экспирации   | дата экспирации фьючерса |
### БиржевыеДанные
| Тип атрибута | Название атрибута | Значение атрибута |
|--------------|-------------------|-------------------|
| float        | го                | ГО                |
| float        | расчётная_цена    | расчётная цена    |
| float        | стоимость_шага    | стоимость шага    |
