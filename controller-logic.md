# Логический уровень контроллера
В данном файле описано устройство контроллера на логическом уровне.

Содержание:
- [Логический уровень контроллера](#логический-уровень-контроллера)
  - [Выбор подхода к реализации](#выбор-подхода-к-реализации)
  - [Термины](#термины)
  - [Архитектура контроллера](#архитектура-контроллера)
    - [ИнтерфейсАналитики](#интерфейсаналитики)
    - [ИнтерфейсФреймворка](#интерфейсфреймворка)
  - [Процессы](#процессы)
    - [Основной процесс](#основной-процесс)
    - [Отправка заявок](#отправка-заявок)
  - [Структуры данных](#структуры-данных)
    - [АналитическаяСвеча](#аналитическаясвеча)
    - [АналитическаяЗаявка](#аналитическаязаявка)
    - [АналитическийОтветНаЗаявку](#аналитическийответназаявку)
    - [Фьючерс](#фьючерс)
    - [БиржевыеДанные](#биржевыеданные)

## Выбор подхода к реализации
Фреймворк должен в себе сочетать **ООП** (объектно ориентированное программирование) и **ФП** (функциональное программирование).

ФП позволяет сделать код более читабельным и простым, однако ФП в чистом виде не подходит, т.к. есть необходимость хранить и изменять объекты. Поэтому во фреймворке также должны быть использованы принципы ООП. Однако использовать только ООП тоже неправильно, потому что во многих частях программы ООП будет излишнем и создаст дополнительные сложности.

От ООП берём:
- возможность хранить и изменять объекты

От ФП берём:
- простота
- чистые функции

## Термины
- Позиции — открытые сделки по инструментам
- Аналитические свечи — свечи в формате аналитики.

## Архитектура контроллера

<!-- Общая архитектура робота представляет собой набор из следующих сервисов:
- `Планировщик` — отвечает за запуск всех событий в роботе
- `Свечи` — отвечает за отправку свечей в аналитику в нужном формате
- `Индексы` — отвечает за определение индексов свечей для аналитики
- `Сценарии` — отвечает за определение сценариев свечей
- `Фьючерсы` — отвечает за хранение, обновление информации о текущих фьючерсах
- `Позиции` — отвечает за то, чтобы позиции на бирже соответствовали позициям в аналитике.
- `ХранилищеБиржевыхДанных` — отвечает за хранение и обновление биржевых данных (ГО, Расчётная цена, Стоимость шага)
- `ИнтерфейсАналитики` — отвечает за непосредственную передачу данных аналитике -->


```mermaid
classDiagram
  
  direction LR

    class Планировщик{
      +запустить_планировщик()
    }

    class Свечи{
      +передать_свечи_аналитике()
    }

    class Сценарии{
      +получить_сценарии()
    }

    class Индексы{
      +получить_индекс_следующих_свеч()
    }

    class Фьючерсы{
      +обновить_фьючерсы()
    }

    class Позиции{
      +балансировать_позиции()
    }

    class ХранилищеБиржевыхДанных{
      +обновить_биржевые_данные()
      +получить_биржевые_данные()
    }

    Планировщик --> Свечи : даёт команду отправить свечи в аналитику
    Свечи --> Сценарии : запрашивает сценарии свечей для исполнения
    Сценарии --> Свечи : возвращает сценарии для исполнения
    Свечи --> Индексы
    Планировщик --> Фьючерсы
    Планировщик --> Позиции
    Планировщик --> ХранилищеБиржевыхДанных
```
### ИнтерфейсАналитики
— модуль, через который фреймворк взаимодействует с аналитикой. 

```mermaid
classDiagram
  class ИнтерфейсАналитики{
    +обработать_свечи(аналитические свечи) Заявки
    +обработать_ответы_на_заявки(ответы на заявки) None
  }

```

Описание интерфейса:
- +обработать_свечи() — обрабатывает [аналитические свечи](#термины) и на основе них возвращает решение о покупке/продаже тикеров в виде [аналитических заявок](#аналитическаязаявка).
- +обработать_ответы_на_заявки() — обрабатывает ответы на отправленные заявки.

### ИнтерфейсФреймворка
—— класс, через который аналитика взаимодействует с фреймворком.

```mermaid
classDiagram
  class ИнтерфейсФреймворка{
    +получить_исторические_свечи(тикер, период) исторические свечи
    +получить_стоимость_портфеля() стоимость портфеля
  }

```

Описание интерфейса:
- получить_исторические_свечи() — возвращает массив с ценами закрытий за указанное количество дней.
- получить_стоимость_портфеля() — возвращает текущую стоимость портфеля

<!-- 

https://www.umlboard.com/docs/relations/

https://www.ibm.com/docs/en/dmrt/9.5?topic=diagrams-dependency-relationships

 -->
<!-- 
### Планировщик
— модуль, отвечающий за запуск всех событий в роботе

```mermaid
classDiagram
    class Планировщик{
      +запустить_планировщик() 
    }
```

Описание интерфейса:
- запустить_планировщик() — начинает бесконечный цикл, в которым происходят все события в контроллере, включая отправку свечей в аналитику, отправку заявок на биржу и т.д.


### Свечи
— модуль, отвечающий за создание аналитических свечей и поставку их в аналитику. Формат аналитических свечей расписан [здесь](#свеча).

```mermaid
classDiagram

  class Свечи{
    +передать_свечи_аналитике()
    +получить_исторические_свечи()
  }

```

Описание интерфейса:
- передать_свечи_аналитике() — создаёт и отправляет свечи в аналитику.
- получить_исторические_свечи() — возвращает исторические свечи для аналитики.


### Индексы
— модуль, отвечающий за индексы свечей, передаваемых в аналитику.

У каждого набора свечей, передаваемых аналитике должен быть свой индекс. Эти индексы должны генерироваться по определённым правилам, которые должен реализовать модуль `Индексы`.

```mermaid
classDiagram
  class Индексы{
    +получить_индекс_следующих_свечей()
  }
```

Описание интерфейса:
- получить_индекс_следующих_свечей() — возвращает индексы свечей.

### Сценарии
— модуль, отвечающий за определение сценариев свечей. 

```mermaid
classDiagram
  class Сценарии{
    +получить_сценарии()
  }
```

Описание интерфейса:
- получить_сценарии() — возвращает сценарии свечей.

### Фьючерсы
— модуль, отвечающий за хранение, обновление информации о текущих фьючерсах.

```mermaid
classDiagram
    class Фьючерсы{
      +обновить_фьючерсы()
    }
```

Описание интерфейса:
- обновить_фьючерсы() — обновляет информацию о текущих фьючерсах.

### Позиции
— модуль, отвечающий за то, чтобы позиции на бирже соответствовали позициям в аналитике. 

```mermaid
classDiagram
  class Позиции{
    +балансировать_позиции()
  }
```
Описание интерфейса:
- балансировать_позиции() — открывает/закрывает позиции на биржи так, чтобы они соответствовали аналитическим позициям.


### ХранилищеБиржевыхДанных
— модуль, отвечающий за хранение и обновление биржевых данных. Формат биржевых данных описан [здесь](#биржевыеданные).

```mermaid
classDiagram
  class ХранилищеБиржевыхДанных{
    +обновить_биржевые_данные()
    +получить_биржевые_данные()
  }
```
Описание интерфейса:
- обновить_биржевые_данные() — обновляет биржевые данные.
- получить_биржевые_данные() — возвращает биржевые данные. 


-->
## Процессы
### Основной процесс

```mermaid
sequenceDiagram
    participant Framework as Фреймворк
    participant Analytics as ИнтерфейсАналитики
    participant Broker as Брокер

    activate Framework
    Framework->>Analytics: обработать_свечи(аналитические свечи)
    Analytics-->>Framework: возвращает заявки
    Framework->>Broker: отправляет заявки
    deactivate Framework
    Broker-->>Framework: возвращает ответы
    activate Framework
    Framework->>Analytics: обработать_ответы_на_заявки(ответы на заявки)
    deactivate Framework

```

<!-- ### Аналитические свечи
```mermaid
sequenceDiagram
    autonumber
    Планировщик->>Свечи: Запускает отправку свечей в аналитику
    Сценарии->>Свечи: Возвращает сценарии свечей
    Адаптер->>Свечи: Возвращает сырые свечи
    ХранилищеБиржевыхДанных->>Свечи: Возвращает биржевые данные
    Индексы->>Свечи: Возвращает индекс свечей
    Свечи->>ИнтерфейсАналитики: Передаёт аналитические свечи
    ИнтерфейсАналитики->>Аналитика: Передаёт аналитические свечи
    Аналитика->>ИнтерфейсАналитики: Возвращает заявки
    Аналитика->>ИнтерфейсАналитики: Возвращает заявки
``` -->
### Отправка заявок

```mermaid
sequenceDiagram
    autonumber
    Аналитика->>Аналитика: Меняет позиции
    Позиции->>Аналитика: Запрашивает позиции
    Позиции->>Адаптер: Отправляет заявки

```
## Структуры данных
### АналитическаяСвеча
| Тип атрибута | Название атрибута | Значение атрибута      |
|--------------|-------------------|------------------------|
| date         | дата              | дата свечи             |
| int          | индекс            | индекс свечи           |
| float        | цена              | цена закрытия свечи    |
| str          | код               | код фьючерса свечи     |
| str          | сценарий          | сценарий               |
| str          | тикер             | тикер                  |
| float        | го                | текущее ГО             |
| float        | расчётная_цена    | текущая расчётная цена |
| float        | стоимость_шага    | текущая стоимость шага |

Атрибут `сценарий` может быть равен:
- NRL — нормальная свеча
- FF — первая свеча фьючерса
- LF — последняя свеча фьючерса
### АналитическаяЗаявка
| Тип атрибута | Название атрибута | Значение атрибута                                       |
|--------------|-------------------|---------------------------------------------------------|
| str          | тикер             | тикер                                                   |
| str          | направление       | направление заявки (либо "B" покупка, либо "S" продажа) |
| int          | количество        | количество лотов в заявке                               |
### АналитическийОтветНаЗаявку
| Тип атрибута | Название атрибута | Значение атрибута                                       |
|--------------|-------------------|---------------------------------------------------------|
| str          | тикер             | тикер                                                   |
| str          | направление       | направление заявки (либо "B" покупка, либо "S" продажа) |
| int          | количество        | количество исполненных лотов                            |
### Фьючерс
Формат, в котором хранится информация о фьючерсе:
| Тип атрибута | Название атрибута | Значение атрибута        |
|--------------|-------------------|--------------------------|
| str          | тикер             | тикер                    |
| str          | код               | код фьючерса             |
| date         | дата_экспирации   | дата экспирации фьючерса |
### БиржевыеДанные
| Тип атрибута | Название атрибута | Значение атрибута |
|--------------|-------------------|-------------------|
| float        | го                | ГО                |
| float        | расчётная_цена    | расчётная цена    |
| float        | стоимость_шага    | стоимость шага    |
